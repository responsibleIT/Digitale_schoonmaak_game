<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboardgame ‚Äì Host</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container">
    <h1>Host Dashboard</h1>

    <div class="card">
      <div class="stack">
        <button id="start" class="primary">Start sessie</button>

        <!-- Session box shown after host:start -->
        <div id="sessionBox" class="hidden">
          <h2>Sessie ID: <span id="sessionId"></span></h2>
          <p class="muted">Laat spelers dit ID invullen op het join-scherm.</p>

          <section class="card" style="background: transparent; border-color: var(--border);">
            <h3>Lobby</h3>
            <p class="muted">Deelnemers die zijn aangesloten:</p>
            <ul id="hostLobbyUsers"></ul>
          </section>

          <div class="row gap">
            <button id="begin" class="primary">Start het spel</button>
            <button id="refreshStats" class="secondary">Vernieuw stats</button>
            <button id="end" class="danger">Be√´indig sessie</button>
          </div>

          <section class="stats">
            <h3>Leaderboard</h3>
            <ol id="leaderboard"></ol>
            <p id="totals" class="muted"></p>
          </section>
        </div>
      </div>
    </div>
  </main>

  <script type="module" src="/js/socket.js"></script>
  <script type="module">
  import { socket, connectSocket } from "/js/socket.js";

  connectSocket();

  const $ = (s) => document.querySelector(s);
  const startBtn    = $("#start");
  const beginBtn    = $("#begin");
  const endBtn      = $("#end");
  const sessionBox  = $("#sessionBox");
  const sessionIdEl = $("#sessionId");
  const lobbyList   = $("#hostLobbyUsers");

  // Nieuwe elementen
  const podiumEl    = document.createElement("div"); podiumEl.id = "podium";
  const tableWrap   = document.createElement("div"); tableWrap.id = "lbWrap";
  const totalsEl    = document.createElement("div"); totalsEl.id = "totalsHost";
  sessionBox.appendChild(podiumEl);
  sessionBox.appendChild(tableWrap);
  sessionBox.appendChild(totalsEl);

  let sessionId;

  function setSessionId(id){ sessionIdEl.textContent = id; sessionBox.classList.remove("hidden"); }

  startBtn?.addEventListener("click", () => socket.emit("host:start"));
  beginBtn?.addEventListener("click", () => {
    if (sessionId) {
      socket.emit("host:begin", { sessionId });
      socket.emit("presence:request", { sessionId }); // optional
    }
  });
  endBtn?.addEventListener("click", () => sessionId && socket.emit("host:end", { sessionId }));

  socket.on("host:sessionId", (p) => {
    sessionId = p.sessionId;
    setSessionId(sessionId);
    socket.emit("presence:request", { sessionId });
  });

  let allReady = false;

  socket.on("presence", ({ users, phase, allReady }) => {
    const beginBtn = document.getElementById("begin");
    if (beginBtn) {
      beginBtn.disabled = !allReady;
      beginBtn.style.opacity = allReady ? "1" : ".6";
      beginBtn.title = allReady ? "" : "Waiting for all players to finish loading‚Ä¶";
    }

    const lobbyList = document.getElementById("hostLobbyUsers");
    if (lobbyList) {
      lobbyList.innerHTML = (users ?? []).map(u => {
        const st = u.status || {};
        const state = st.ready ? "‚úÖ Ready"
          : st.selected ? `‚è≥ ${st.loadingPct ?? 0}% (${st.filesCount ?? 0})`
          : "‚¨ú Not selected";
        return `<li>${u.displayName} ‚Äî ${state}</li>`;
      }).join("");
    }
  });

  socket.on("stats", (snap) => {
    // your existing renderStats(snap)
    renderStats(snap);
  });
  socket.on("game:event", (ev) => {
    // optional: the toast/confetti handler from earlier
    showEvent(ev);
  });

  function renderStats(snap) {
    // Podium (top 3)
    const top = (snap.leaderboard ?? []).slice(0,3);
    podiumEl.innerHTML = `
      <div class="podium">
        ${[1,0,2].map(i => {
          const p = top[i];
          return `
            <div class="step step-${i}">
              <div class="name">${p ? p.displayName : "-"}</div>
              <div class="score">${p ? (p.bytes/1_000_000).toFixed(1) : "0"} MB</div>
            </div>`;
        }).join("")}
      </div>`;

    // Tabel (vanaf #4)
    const rest = (snap.leaderboard ?? []).slice(3);
    tableWrap.innerHTML = `
      <table class="leader">
        <thead><tr>
          <th>#</th><th>Naam</th><th>MB</th><th>Items</th><th>Streak</th><th>Tempo</th><th>Grootste</th>
        </tr></thead>
        <tbody>
          ${rest.map((r, idx) => `
            <tr>
              <td>${idx+4}</td>
              <td>${r.displayName}</td>
              <td>${(r.bytes/1_000_000).toFixed(1)}</td>
              <td>${r.items}</td>
              <td>${r.streak}</td>
              <td>${r.ratePerMin.toFixed(0)}/min</td>
              <td>
                ${
                  r.largestName
                    ? `${r.largestName} (${r.largestSize ? (r.largestSize / 1_000_000).toFixed(0) + "MB" : "-"})`
                    : "-"
                }
              </td>
            </tr>`).join("")}
        </tbody>
      </table>`;

    totalsEl.innerHTML = `
      <div class="totals">
        <div><strong>Totaal:</strong> ${(snap.totalBytes/1_000_000).toFixed(0)} MB over ${snap.totalItems} items</div>
        <div><strong>CO‚ÇÇ bespaard (speels):</strong> ${snap.totalCo2kg.toFixed(2)} kg</div>
      </div>`;
  }

  // Toasts + confetti voor events
  function showEvent(ev){
    const titles = {
      "first-blood": "Eerste klapper!",
      "streak": "Combo!",
      "chonk": "Dik bestand!",
      "milestone-bytes": "Mijlpaal!",
      "milestone-items": "Mijlpaal!"
    };
    const msg = (() => {
      switch(ev.type){
        case "first-blood": return `${ev.displayName} startte het feest üéâ`;
        case "streak": return `${ev.displayName} heeft een streak van ${ev.payload.streak}! üî•`;
        case "chonk": return `${ev.displayName} verwijderde ${(ev.payload.size/1_000_000).toFixed(0)} MB (${ev.payload.itemName}) üí™`;
        case "milestone-bytes": return `${ev.displayName} passeerde ${ev.payload.totalMB} MB!`;
        case "milestone-items": return `${ev.displayName} tikte ${ev.payload.totalItems} items aan!`;
        default: return `${ev.displayName} is lekker bezig!`;
      }
    })();

    toast(`${titles[ev.type] ?? "Nice!"}`, msg);
    confettiBurst();
  }

  // super simpele toast
  function toast(title, text){
    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = `<div class="toast-title">${title}</div><div>${text}</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.classList.add("show"), 10);
    setTimeout(() => { t.classList.remove("show"); setTimeout(()=>t.remove(), 300); }, 3000);
  }

  // mini confetti zonder lib
  function confettiBurst() {
    const c = document.createElement("canvas");
    c.className = "confetti";
    c.width = window.innerWidth; c.height = 200;
    document.body.appendChild(c);
    const ctx = c.getContext("2d");

    const bits = Array.from({ length: 120 }, () => ({
      x: Math.random()*c.width, y: -10, s: 4+Math.random()*6,
      vy: 2+Math.random()*3, vx: -1+Math.random()*2
    }));

    let frames = 0;
    function tick(){
      ctx.clearRect(0,0,c.width,c.height);
      bits.forEach(b=>{
        b.x += b.vx; b.y += b.vy;
        ctx.fillRect(b.x,b.y,b.s,b.s);
      });
      frames++;
      if (frames < 60) requestAnimationFrame(tick);
      else c.remove();
    }
    tick();
  }
</script>
</body>
</html>
