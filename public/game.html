<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container">
    <h1>Player</h1>

    <div class="card">
      <!-- LOBBY -->
      <div id="lobby">
        <h2>Lobby</h2>
        <p class="muted">Waiting for the host to start the game‚Ä¶</p>
        <ul id="lobbyUsers"></ul>

        <!-- PRELOAD BOX: players MUST pick a folder first -->
        <div id="preloadBox" class="lobby" style="margin-top:12px;">
          <h3>Select your folder</h3>
          <p class="muted">
            Choose a local folder to clean. We‚Äôll scan it <strong>locally</strong> (nothing is uploaded).
            Use Chrome/Edge.
          </p>
          <div class="row gap">
            <button id="pickFolder" class="primary">Choose folder</button>
            <div id="loadStatus" class="muted"></div>
          </div>
          <div id="loadBarOuter" style="margin-top:8px; background:#eef2ff; border-radius:10px; height:10px; width:320px;">
            <div id="loadBar" style="height:10px; width:0; background:linear-gradient(90deg,#6a5ae0,#8f85ff); border-radius:10px;"></div>
          </div>
        </div>
      </div>

      <!-- GAME UI -->
      <div id="gameUI" class="hidden">
        <div class="row gap wrap">
          <div class="muted">Drag a file onto the monster to move it to <code>.DashboardgameTrash</code>.</div>
          <a href="/" class="secondary">Back to join</a>
        </div>
        <div id="files" class="file-grid"></div>
        <div id="monster" class="monster" tabindex="0" title="Drop here">üßü‚Äç‚ôÇÔ∏è Drop here</div>
      </div>
    </div>
  </main>

  <script type="module">
    import { socket, connectSocket } from "/js/socket.js";
    import { getQuery } from "/js/ui.js";
    import { pickRoot, scanWithProgress, softDeleteById } from "/js/fs-local.js";

    const { sessionId, userId, displayName } = getQuery();

    // DOM
    const lobby       = document.getElementById("lobby");
    const lobbyUsers  = document.getElementById("lobbyUsers");
    const preloadBox  = document.getElementById("preloadBox");
    const loadStatus  = document.getElementById("loadStatus");
    const loadBar     = document.getElementById("loadBar");
    const gameUI      = document.getElementById("gameUI");
    const filesDiv    = document.getElementById("files");
    const monster     = document.getElementById("monster");
    const pickBtn     = document.getElementById("pickFolder");

    // Local mode state
    let rootHandle = null;
    let idToHandle = new Map();
    let idToParent = new Map();
    let preloadedFiles = [];
    let isReady = false;

    // ---- Socket wiring ----
    connectSocket();
    const emitJoin = () => socket.emit("client:join", { sessionId, userId, displayName });
    if (socket.connected) emitJoin(); else socket.once("connect", emitJoin);

    socket.emit("presence:request", { sessionId });

    socket.on("presence", ({ users, phase, allReady }) => {
      // Render who‚Äôs ready/loading/not selected
      lobbyUsers.innerHTML = (users ?? []).map(u => {
        const st = u.status || {};
        const state = st.ready ? "Ready"
          : st.selected ? `${st.loadingPct ?? 0}% (${st.filesCount ?? 0})`
          : "Not selected";
        return `<li>${u.displayName} ‚Äî ${state}</li>`;
      }).join("");

      if (phase === "started") showGame();
    });

    socket.on("game:started", () => showGame());

    // ---- Folder selection + scanning ----
    pickBtn?.addEventListener("click", async () => {
      try {
        if (!("showDirectoryPicker" in window)) {
          alert("Your browser does not support Local Folder access. Please use Chrome or Edge.");
          return;
        }

        rootHandle = await pickRoot();
        socket.emit("client:select", { sessionId, userId });

        let processed = 0;
        updateProgress(0, "Scanning‚Ä¶");

        const { files, idToHandle: mapA, idToParentDir: mapB } =
          await scanWithProgress(rootHandle, {
            maxDepth: 10,
            onProgress: ({ processed: p }) => {
              processed = p;
              // We don't know total; fake an easing bar to ~90%
              const pct = Math.min(90, Math.round(Math.log10(2 + p) * 100 / 2));
              updateProgress(pct, `Scanning‚Ä¶ ${processed} files`);
              socket.emit("client:loading", {
                sessionId, userId,
                loadingPct: pct, filesCount: processed
              });
            }
          });

        idToHandle = mapA;
        idToParent = mapB;
        preloadedFiles = files;
        isReady = true;

        updateProgress(100, `Ready (${files.length} files)`);
        socket.emit("client:ready", { sessionId, userId, filesCount: files.length });
        socket.emit("presence:request", { sessionId });
      } catch (e) {
        console.error(e);
        alert("Folder selection cancelled or failed.");
      }
    });

    function updateProgress(pct, text) {
      if (loadBar) loadBar.style.width = pct + "%";
      if (loadStatus) loadStatus.textContent = text || "";
    }

    // ---- Game rendering ----
    function showGame() {
      // Only proceed to game if the player actually scanned (isReady)
      if (!isReady) {
        // keep lobby visible; nudge user
        updateProgress(0, "Please choose a folder first.");
        return;
      }
      lobby?.classList.add("hidden");
      preloadBox?.classList.add("hidden");
      gameUI?.classList.remove("hidden");
      renderFiles(preloadedFiles);
    }

    function renderFiles(items) {
      filesDiv.innerHTML = (items ?? []).map((f) => `
        <div class="file" draggable="true"
             data-id="${f.id}" data-name="${f.name}" data-size="${f.size}">
          <div class="file-name">${f.name}</div>
          <div class="file-size">${(Number(f.size)/1_000_000).toFixed(2)} MB</div>
        </div>
      `).join("");

      filesDiv.querySelectorAll('.file[draggable="true"]').forEach((el) => {
        el.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", JSON.stringify({
            id: el.dataset.id,
            name: el.dataset.name,
            size: Number(el.dataset.size),
          }));
        });
      });
    }

    // Drag ‚Üí soft delete (move to .DashboardgameTrash)
    monster?.addEventListener("dragover", (e) => e.preventDefault());
    monster?.addEventListener("drop", async (e) => {
      e.preventDefault();
      try {
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        await softDeleteById(rootHandle, data.id, idToHandle, idToParent);

        filesDiv.querySelector(`[data-id="${data.id}"]`)?.remove();

        // small flair
        const s = document.createElement("span"); s.className = "mini-pop"; document.body.appendChild(s);
        setTimeout(() => s.remove(), 500);
      } catch (err) {
        alert("Could not delete. Try again.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
